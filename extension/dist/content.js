function A(){const t=Array.from(document.querySelectorAll('article[data-testid^="conversation-turn-"]'));return t.length>0?t[t.length-1].innerText.trim():null}function g(t){const e=["p","span","div","li","blockquote","h1","h2","h3"],n=[];function o(i){if(!(i instanceof HTMLElement))return!1;const r=window.getComputedStyle(i);return r.display!=="none"&&r.visibility!=="hidden"&&r.opacity!=="0"}function s(i){if(o(i)){if(e.includes(i.tagName.toLowerCase())){const r=i.innerText;r&&r.trim().length>0&&n.push(r.trim())}for(const r of Array.from(i.children))s(r)}}return s(t),n.join(`
`)}function w(t){let e=t,n=0;const o=10,s=100;let l="";for(;e&&e!==document.body&&n<o;){const i=e.getAttribute("role"),r=["main","article","region","dialog","section"].includes(i||""),x=e.hasAttribute("data-testid");if(r||x){const u=g(e);if(u.replace(/\s+/g,"").length>=s)return u}let d=e.previousElementSibling;for(;d;){const u=g(d);if(u.replace(/\s+/g,"").length>=s)return u;d=d.previousElementSibling}const y=g(e);y.replace(/\s+/g,"").length>l.length&&(l=y),e=e.parentElement,n++}return l.replace(/\s+/g,"").length>=s?l:document.title||""}function T(t){const e=A();return e?(console.log("using chatgpt context"),e):(console.log("using generic context"),w(t))}function C(){const t=document.createElement("span");return t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.opacity="0.5",t.style.color="#666",t.style.pointerEvents="none",t}function h(t){return t.replace(/[&<>'"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[e])}function I(t){const e=window.getComputedStyle(t).color;let n=0,o=0,s=0;if(e.startsWith("rgb"))[n,o,s]=e.match(/\d+/g).map(Number);else if(e.startsWith("#")){const i=e.replace("#","");i.length===3?(n=parseInt(i[0]+i[0],16),o=parseInt(i[1]+i[1],16),s=parseInt(i[2]+i[2],16)):i.length===6&&(n=parseInt(i.slice(0,2),16),o=parseInt(i.slice(2,4),16),s=parseInt(i.slice(4,6),16))}return(n*299+o*587+s*114)/1e3>180?"rgba(255,255,255,0.7)":"rgba(60,60,60,0.7)"}function v(t,e,n,o){const s=t.getBoundingClientRect();n.style.position="absolute",n.style.left=`${s.left+window.scrollX}px`,n.style.top=`${s.top+window.scrollY}px`,n.style.width=`${s.width}px`,n.style.height=`${s.height}px`,n.style.fontSize=window.getComputedStyle(t).fontSize,n.style.fontFamily=window.getComputedStyle(t).fontFamily,n.style.padding=window.getComputedStyle(t).padding,n.style.border=window.getComputedStyle(t).border,n.style.background="transparent",n.style.zIndex="999999",n.style.pointerEvents="none",n.style.whiteSpace="pre-wrap",n.style.display="block";const l=I(t);n.innerHTML=`<span style='opacity:0; user-select:none;'>${h(o(t))}</span><span style='opacity:0.7; color:${l};'>${h(e)}</span>`}const E="http://localhost:3000/api";async function S(t,e){console.log("[AI Autocomplete] Fetching suggestion for input:",t);try{const n=await fetch(`${E}/autocomplete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:t,context:e})});if(!n.ok)throw new Error("Failed to get suggestion");const o=await n.json();return console.log("[AI Autocomplete] Suggestion received:",o.suggestion),o.suggestion}catch(n){return console.error("[AI Autocomplete] Error getting suggestion:",n),null}}function f(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value:t instanceof HTMLElement&&t.isContentEditable?t.innerText:""}function L(t,e){t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value=e:t instanceof HTMLElement&&t.isContentEditable&&(t.innerText=e)}let a=null,c=null,p=null;function m(t){const e=t.target,n=f(e);console.log("[AI Autocomplete] Input event detected:",n),a=null,c&&c.parentElement&&(console.log("[AI Autocomplete] Removing ghost element"),c.remove(),c=null),p&&clearTimeout(p),p=window.setTimeout(async()=>{if(!n.trim())return;const o=T(e);console.log("[AI Autocomplete] Extracted context:",o),console.log("context length:",o.length);const s=o.slice(0,1e3);console.log("limit context length:",s.length);const l=await S(n,s);l&&(a=l,c||(c=C(),document.body.appendChild(c)),v(e,l,c,f))},1e3)}function b(t){console.log("handleKeyDown");const e=t,n=e.target;if((e.key==="Tab"||e.key==="ArrowRight")&&a){if(console.log("[AI Autocomplete] Accepting suggestion with key:",e.key),e.preventDefault(),n instanceof HTMLElement&&n.isContentEditable)n.focus(),document.execCommand("insertText",!1,a)||alert("Could not insert suggestion. Please paste manually.");else{const o=f(n)+a;L(n,o)}a=null,c&&(c.remove(),c=null)}}console.log("[AI Autocomplete] Content script loaded");function M(){const t=document.querySelectorAll('input:not([type="password"]), textarea, [contenteditable="true"]');console.log(`[AI Autocomplete] Initializing. Found ${t.length} input(s)/textarea(s).`),t.forEach(e=>{e.addEventListener("input",m),e.addEventListener("keydown",b),console.log("[AI Autocomplete] Listener attached to:",e)})}document.addEventListener("DOMContentLoaded",M);const H=new MutationObserver(t=>{t.forEach(e=>{e.addedNodes.length&&document.querySelectorAll('input:not([type="password"]), textarea, [contenteditable="true"]').forEach(o=>{o.hasAttribute("data-autocomplete-initialized")||(o.addEventListener("input",m),o.addEventListener("keydown",b),o.setAttribute("data-autocomplete-initialized","true"),console.log("[AI Autocomplete] Listener attached to (dynamic):",o))})})});H.observe(document.body,{childList:!0,subtree:!0});
