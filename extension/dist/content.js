function T(){const t=Array.from(document.querySelectorAll('article[data-testid^="conversation-turn-"]'));return t.length>0?t[t.length-1].innerText.trim():null}function g(t){const e=["p","span","div","li","blockquote","h1","h2","h3"],n=[];function o(s){if(!(s instanceof HTMLElement))return!1;const c=window.getComputedStyle(s);return c.display!=="none"&&c.visibility!=="hidden"&&c.opacity!=="0"}function i(s){if(o(s)){if(e.includes(s.tagName.toLowerCase())){const c=s.innerText;c&&c.trim().length>0&&n.push(c.trim())}for(const c of Array.from(s.children))i(c)}}return i(t),n.join(`
`)}function v(t){let e=t,n=0;const o=10,i=100;let r="";for(;e&&e!==document.body&&n<o;){const s=e.getAttribute("role"),c=["main","article","region","dialog","section"].includes(s||""),x=e.hasAttribute("data-testid");if(c||x){const u=g(e);if(u.replace(/\s+/g,"").length>=i)return u}let d=e.previousElementSibling;for(;d;){const u=g(d);if(u.replace(/\s+/g,"").length>=i)return u;d=d.previousElementSibling}const y=g(e);y.replace(/\s+/g,"").length>r.length&&(r=y),e=e.parentElement,n++}return r.replace(/\s+/g,"").length>=i?r:document.title||""}function I(t){const e=T();return e?(console.log("using chatgpt context"),e):(console.log("using generic context"),v(t))}function C(){const t=document.createElement("span");return t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.opacity="0.5",t.style.color="#666",t.style.pointerEvents="none",t}function h(t){return t.replace(/[&<>'"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[e])}function E(t){const e=window.getComputedStyle(t).color;let n=0,o=0,i=0;if(e.startsWith("rgb"))[n,o,i]=e.match(/\d+/g).map(Number);else if(e.startsWith("#")){const s=e.replace("#","");s.length===3?(n=parseInt(s[0]+s[0],16),o=parseInt(s[1]+s[1],16),i=parseInt(s[2]+s[2],16)):s.length===6&&(n=parseInt(s.slice(0,2),16),o=parseInt(s.slice(2,4),16),i=parseInt(s.slice(4,6),16))}return(n*299+o*587+i*114)/1e3>180?"rgba(255,255,255,0.7)":"rgba(60,60,60,0.7)"}function L(t,e,n,o){const i=t.getBoundingClientRect();n.style.position="absolute",n.style.left=`${i.left+window.scrollX}px`,n.style.top=`${i.top+window.scrollY}px`,n.style.width=`${i.width}px`,n.style.height=`${i.height}px`,n.style.fontSize=window.getComputedStyle(t).fontSize,n.style.fontFamily=window.getComputedStyle(t).fontFamily,n.style.padding=window.getComputedStyle(t).padding,n.style.border=window.getComputedStyle(t).border,n.style.background="transparent",n.style.zIndex="999999",n.style.pointerEvents="none",n.style.whiteSpace="pre-wrap",n.style.display="block";const r=E(t);n.innerHTML=`<span style='opacity:0; user-select:none;'>${h(o(t))}</span><span style='opacity:0.7; color:${r};'>${h(e)}</span>`}const m="https://everything-pilot.vercel.app/api";async function S(t,e){console.log("[AI Autocomplete] Fetching suggestion for input:",t),console.log("[AI Autocomplete] API Base URL:",m);try{const n=window.location.hostname,o=await fetch(`${m}/autocomplete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:t,context:e,site:n})});if(!o.ok)throw new Error("Failed to get suggestion");const i=await o.json();return console.log("[AI Autocomplete] Suggestion received:",i.suggestion),i.suggestion}catch(n){return console.error("[AI Autocomplete] Error getting suggestion:",n),null}}function f(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value:t instanceof HTMLElement&&t.isContentEditable?t.innerText:""}function M(t,e){t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value=e:t instanceof HTMLElement&&t.isContentEditable&&(t.innerText=e)}let a=null,l=null,p=null;function A(t){const e=t.target,n=f(e);console.log("[AI Autocomplete] Input event detected:",n),a=null,l&&l.parentElement&&(console.log("[AI Autocomplete] Removing ghost element"),l.remove(),l=null),p&&clearTimeout(p),p=window.setTimeout(async()=>{if(!n.trim())return;const o=I(e);console.log("[AI Autocomplete] Extracted context:",o),console.log("context length:",o.length);const i=o.slice(0,1e3);console.log("limit context length:",i.length);const r=await S(n,i);r&&(a=r,l||(l=C(),document.body.appendChild(l)),L(e,r,l,f))},1e3)}function b(t){console.log("handleKeyDown");const e=t,n=e.target;if((e.key==="Tab"||e.key==="ArrowRight")&&a){if(console.log("[AI Autocomplete] Accepting suggestion with key:",e.key),e.preventDefault(),n instanceof HTMLElement&&n.isContentEditable)n.focus(),document.execCommand("insertText",!1,a)||alert("Could not insert suggestion. Please paste manually.");else{const o=f(n)+a;M(n,o)}a=null,l&&(l.remove(),l=null)}}function w(t){a=null,l&&(l.remove(),l=null)}console.log("[AI Autocomplete] Content script loaded");function H(){const t=document.querySelectorAll('input:not([type="password"]), textarea, [contenteditable="true"]');console.log(`[AI Autocomplete] Initializing. Found ${t.length} input(s)/textarea(s).`),t.forEach(e=>{e.addEventListener("input",A),e.addEventListener("keydown",b),e.addEventListener("focusout",w),console.log("[AI Autocomplete] Listener attached to:",e)})}document.addEventListener("DOMContentLoaded",H);const k=new MutationObserver(t=>{t.forEach(e=>{e.addedNodes.length&&document.querySelectorAll('input:not([type="password"]), textarea, [contenteditable="true"]').forEach(o=>{o.hasAttribute("data-autocomplete-initialized")||(o.addEventListener("input",A),o.addEventListener("keydown",b),o.addEventListener("focusout",w),o.setAttribute("data-autocomplete-initialized","true"),console.log("[AI Autocomplete] Listener attached to (dynamic):",o))})})});k.observe(document.body,{childList:!0,subtree:!0});
