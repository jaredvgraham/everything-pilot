function v(){const e=Array.from(document.querySelectorAll('article[data-testid^="conversation-turn-"]'));return e.length>0?e[e.length-1].innerText.trim():null}function g(e){const t=["p","span","div","li","blockquote","h1","h2","h3"],o=[];function n(i){if(!(i instanceof HTMLElement))return!1;const c=window.getComputedStyle(i);return c.display!=="none"&&c.visibility!=="hidden"&&c.opacity!=="0"}function s(i){if(n(i)){if(t.includes(i.tagName.toLowerCase())){const c=i.innerText;c&&c.trim().length>0&&o.push(c.trim())}for(const c of Array.from(i.children))s(c)}}return s(e),o.join(`
`)}function T(e){let t=e,o=0;const n=10,s=100;let r="";for(;t&&t!==document.body&&o<n;){const i=t.getAttribute("role"),c=["main","article","region","dialog","section"].includes(i||""),b=t.hasAttribute("data-testid");if(c||b){const u=g(t);if(u.replace(/\s+/g,"").length>=s)return u}let d=t.previousElementSibling;for(;d;){const u=g(d);if(u.replace(/\s+/g,"").length>=s)return u;d=d.previousElementSibling}const m=g(t);m.replace(/\s+/g,"").length>r.length&&(r=m),t=t.parentElement,o++}return r.replace(/\s+/g,"").length>=s?r:document.title||""}function E(e){const t=v();return t?(console.log("using chatgpt context"),t):(console.log("using generic context"),T(e))}function C(){const e=document.createElement("span");return e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.opacity="0.5",e.style.color="#666",e.style.pointerEvents="none",e}function y(e){return e.replace(/[&<>'"]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[t])}function I(e){const t=window.getComputedStyle(e).color;let o=0,n=0,s=0;if(t.startsWith("rgb"))[o,n,s]=t.match(/\d+/g).map(Number);else if(t.startsWith("#")){const i=t.replace("#","");i.length===3?(o=parseInt(i[0]+i[0],16),n=parseInt(i[1]+i[1],16),s=parseInt(i[2]+i[2],16)):i.length===6&&(o=parseInt(i.slice(0,2),16),n=parseInt(i.slice(2,4),16),s=parseInt(i.slice(4,6),16))}return(o*299+n*587+s*114)/1e3>180?"rgba(255,255,255,0.7)":"rgba(60,60,60,0.7)"}function L(e,t,o,n){const s=e.getBoundingClientRect();o.style.position="absolute",o.style.left=`${s.left+window.scrollX}px`,o.style.top=`${s.top+window.scrollY}px`,o.style.width=`${s.width}px`,o.style.height=`${s.height}px`,o.style.fontSize=window.getComputedStyle(e).fontSize,o.style.fontFamily=window.getComputedStyle(e).fontFamily,o.style.padding=window.getComputedStyle(e).padding,o.style.border=window.getComputedStyle(e).border,o.style.background="transparent",o.style.zIndex="999999",o.style.pointerEvents="none",o.style.whiteSpace="pre-wrap",o.style.display="block";const r=I(e);o.innerHTML=`<span style='opacity:0; user-select:none;'>${y(n(e))}</span><span style='opacity:0.7; color:${r};'>${y(t)}</span>`}const h="http://localhost:3000/api";async function S(e,t){console.log("[AI Autocomplete] Fetching suggestion for input:",e),console.log("[AI Autocomplete] API Base URL:",h);try{const o=window.location.hostname,n=await fetch(`${h}/autocomplete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:e,context:t,site:o})});if(!n.ok)throw new Error("Failed to get suggestion");const s=await n.json();return console.log("[AI Autocomplete] Suggestion received:",s.suggestion),s.suggestion}catch(o){return console.error("[AI Autocomplete] Error getting suggestion:",o),null}}function f(e){return e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement?e.value:e instanceof HTMLElement&&e.isContentEditable?e.innerText:""}function k(e,t){e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement?e.value=t:e instanceof HTMLElement&&e.isContentEditable&&(e.innerText=t)}let a=null,l=null,p=null;function x(e){const t=e.target,o=f(t);console.log("[AI Autocomplete] Input event detected:",o),a=null,l&&l.parentElement&&(console.log("[AI Autocomplete] Removing ghost element"),l.remove(),l=null),p&&clearTimeout(p),p=window.setTimeout(async()=>{if(!o.trim())return;const n=E(t);console.log("[AI Autocomplete] Extracted context:",n),console.log("context length:",n.length);const s=n.slice(0,1e3);console.log("limit context length:",s.length);const r=await S(o,s);r&&(a=r,l||(l=C(),document.body.appendChild(l)),L(t,r,l,f))},1e3)}function w(e){console.log("handleKeyDown");const t=e,o=t.target;if((t.key==="Tab"||t.key==="ArrowRight")&&a){if(console.log("[AI Autocomplete] Accepting suggestion with key:",t.key),t.preventDefault(),o instanceof HTMLElement&&o.isContentEditable)o.focus(),document.execCommand("insertText",!1,a)||alert("Could not insert suggestion. Please paste manually.");else{const n=f(o)+a;k(o,n)}a=null,l&&(l.remove(),l=null)}}function A(e){a=null,l&&(l.remove(),l=null)}console.log("[AI Autocomplete] Content script loaded");function H(){const e=document.querySelectorAll('input:not([type="password"]), textarea, [contenteditable="true"]');console.log(`[AI Autocomplete] Initializing. Found ${e.length} input(s)/textarea(s).`),e.forEach(t=>{t.addEventListener("input",x),t.addEventListener("keydown",w),t.addEventListener("focusout",A),console.log("[AI Autocomplete] Listener attached to:",t)})}document.addEventListener("DOMContentLoaded",H);const M=new MutationObserver(e=>{e.forEach(t=>{t.addedNodes.length&&document.querySelectorAll('input:not([type="password"]), textarea, [contenteditable="true"]').forEach(n=>{n.hasAttribute("data-autocomplete-initialized")||(n.addEventListener("input",x),n.addEventListener("keydown",w),n.addEventListener("focusout",A),n.setAttribute("data-autocomplete-initialized","true"),console.log("[AI Autocomplete] Listener attached to (dynamic):",n))})})});M.observe(document.body,{childList:!0,subtree:!0});window.addEventListener("message",e=>{var t,o,n;if(console.log("received message from extension-login1"),console.log("received message from extension-login2"),console.log("received message from extension-login3"),console.log("received message from extension-login4"),console.log("received message from extension-login5"),console.log("received message from extension-login6"),console.log("received message from extension-login7"),console.log("received message from extension-login8"),console.log("received message from extension-login9"),console.log("received message from extension-login10"),e.source!==window){console.log("event.source",e.source),console.log("event.sourse is not window");return}if(console.log("event.data",e.data),console.log("event.data.type",(t=e.data)==null?void 0:t.type),console.log("event.data.token",(o=e.data)==null?void 0:o.token),((n=e.data)==null?void 0:n.type)==="CLERK_EXTENSION_AUTH"){console.log("event.data.type is CLERK_EXTENSION_AUTH");const s=e.data.token;s&&(chrome.storage.local.set({jwt:s}),console.log("âœ… Clerk JWT stored securely."),console.log("geting the token:",chrome.storage.local.get("jwt")))}});
